require "./../foundation.cr"
require "./com.cr"

module Win32cr::System::Antimalware
  alias HAMSICONTEXT = LibC::IntPtrT
  alias HAMSISESSION = LibC::IntPtrT

  CLSID_CAntimalware = LibC::GUID.new(0xfdb00e52_u32, 0xa214_u16, 0x4aa1_u16, StaticArray[0x8f_u8, 0xba_u8, 0x43_u8, 0x57_u8, 0xbb_u8, 0x0_u8, 0x72_u8, 0xec_u8])

  enum AMSI_RESULT
    AMSI_RESULT_CLEAN = 0_i32
    AMSI_RESULT_NOT_DETECTED = 1_i32
    AMSI_RESULT_BLOCKED_BY_ADMIN_START = 16384_i32
    AMSI_RESULT_BLOCKED_BY_ADMIN_END = 20479_i32
    AMSI_RESULT_DETECTED = 32768_i32
  end
  enum AMSI_ATTRIBUTE
    AMSI_ATTRIBUTE_APP_NAME = 0_i32
    AMSI_ATTRIBUTE_CONTENT_NAME = 1_i32
    AMSI_ATTRIBUTE_CONTENT_SIZE = 2_i32
    AMSI_ATTRIBUTE_CONTENT_ADDRESS = 3_i32
    AMSI_ATTRIBUTE_SESSION = 4_i32
    AMSI_ATTRIBUTE_REDIRECT_CHAIN_SIZE = 5_i32
    AMSI_ATTRIBUTE_REDIRECT_CHAIN_ADDRESS = 6_i32
    AMSI_ATTRIBUTE_ALL_SIZE = 7_i32
    AMSI_ATTRIBUTE_ALL_ADDRESS = 8_i32
    AMSI_ATTRIBUTE_QUIET = 9_i32
  end
  enum AMSI_UAC_REQUEST_TYPE
    AMSI_UAC_REQUEST_TYPE_EXE = 0_i32
    AMSI_UAC_REQUEST_TYPE_COM = 1_i32
    AMSI_UAC_REQUEST_TYPE_MSI = 2_i32
    AMSI_UAC_REQUEST_TYPE_AX = 3_i32
    AMSI_UAC_REQUEST_TYPE_PACKAGED_APP = 4_i32
    AMSI_UAC_REQUEST_TYPE_MAX = 5_i32
  end
  enum AMSI_UAC_TRUST_STATE
    AMSI_UAC_TRUST_STATE_TRUSTED = 0_i32
    AMSI_UAC_TRUST_STATE_UNTRUSTED = 1_i32
    AMSI_UAC_TRUST_STATE_BLOCKED = 2_i32
    AMSI_UAC_TRUST_STATE_MAX = 3_i32
  end
  enum AMSI_UAC_MSI_ACTION
    AMSI_UAC_MSI_ACTION_INSTALL = 0_i32
    AMSI_UAC_MSI_ACTION_UNINSTALL = 1_i32
    AMSI_UAC_MSI_ACTION_UPDATE = 2_i32
    AMSI_UAC_MSI_ACTION_MAINTENANCE = 3_i32
    AMSI_UAC_MSI_ACTION_MAX = 4_i32
  end

  @[Extern]
  record AMSI_UAC_REQUEST_EXE_INFO,
    ulLength : UInt32,
    lpwszApplicationName : Win32cr::Foundation::PWSTR,
    lpwszCommandLine : Win32cr::Foundation::PWSTR,
    lpwszDLLParameter : Win32cr::Foundation::PWSTR

  @[Extern]
  record AMSI_UAC_REQUEST_COM_INFO,
    ulLength : UInt32,
    lpwszServerBinary : Win32cr::Foundation::PWSTR,
    lpwszRequestor : Win32cr::Foundation::PWSTR,
    clsid : LibC::GUID

  @[Extern]
  record AMSI_UAC_REQUEST_MSI_INFO,
    ulLength : UInt32,
    msi_action : Win32cr::System::Antimalware::AMSI_UAC_MSI_ACTION,
    lpwszProductName : Win32cr::Foundation::PWSTR,
    lpwszVersion : Win32cr::Foundation::PWSTR,
    lpwszLanguage : Win32cr::Foundation::PWSTR,
    lpwszManufacturer : Win32cr::Foundation::PWSTR,
    lpwszPackagePath : Win32cr::Foundation::PWSTR,
    lpwszPackageSource : Win32cr::Foundation::PWSTR,
    ulUpdates : UInt32,
    ppwszUpdates : Win32cr::Foundation::PWSTR*,
    ppwszUpdateSources : Win32cr::Foundation::PWSTR*

  @[Extern]
  record AMSI_UAC_REQUEST_AX_INFO,
    ulLength : UInt32,
    lpwszLocalInstallPath : Win32cr::Foundation::PWSTR,
    lpwszSourceURL : Win32cr::Foundation::PWSTR

  @[Extern]
  record AMSI_UAC_REQUEST_PACKAGED_APP_INFO,
    ulLength : UInt32,
    lpwszApplicationName : Win32cr::Foundation::PWSTR,
    lpwszCommandLine : Win32cr::Foundation::PWSTR,
    lpPackageFamilyName : Win32cr::Foundation::PWSTR,
    lpApplicationId : Win32cr::Foundation::PWSTR

  @[Extern]
  record AMSI_UAC_REQUEST_CONTEXT,
    ulLength : UInt32,
    ulRequestorProcessId : UInt32,
    uac_trust_state : Win32cr::System::Antimalware::AMSI_UAC_TRUST_STATE,
    type__ : Win32cr::System::Antimalware::AMSI_UAC_REQUEST_TYPE,
    request_type : RequestType_e__Union_,
    bAutoElevateRequest : Win32cr::Foundation::BOOL do

    # Nested Type RequestType_e__Union_
    @[Extern(union: true)]
    record RequestType_e__Union_,
      exe_info : Win32cr::System::Antimalware::AMSI_UAC_REQUEST_EXE_INFO,
      com_info : Win32cr::System::Antimalware::AMSI_UAC_REQUEST_COM_INFO,
      msi_info : Win32cr::System::Antimalware::AMSI_UAC_REQUEST_MSI_INFO,
      active_x_info : Win32cr::System::Antimalware::AMSI_UAC_REQUEST_AX_INFO,
      packaged_app_info : Win32cr::System::Antimalware::AMSI_UAC_REQUEST_PACKAGED_APP_INFO

  end

  @[Extern]
  record IAmsiStreamVtbl,
    query_interface : Proc(IAmsiStream*, LibC::GUID*, Void**, Win32cr::Foundation::HRESULT),
    add_ref : Proc(IAmsiStream*, UInt32),
    release : Proc(IAmsiStream*, UInt32),
    get_attribute : Proc(IAmsiStream*, Win32cr::System::Antimalware::AMSI_ATTRIBUTE, UInt32, UInt8*, UInt32*, Win32cr::Foundation::HRESULT),
    read : Proc(IAmsiStream*, UInt64, UInt32, UInt8*, UInt32*, Win32cr::Foundation::HRESULT)


  @[Extern]
  #@[Com("3e47f2e5-81d4-4d3b-897f-545096770373")]
  record IAmsiStream, lpVtbl : IAmsiStreamVtbl* do
    GUID = LibC::GUID.new(0x3e47f2e5_u32, 0x81d4_u16, 0x4d3b_u16, StaticArray[0x89_u8, 0x7f_u8, 0x54_u8, 0x50_u8, 0x96_u8, 0x77_u8, 0x3_u8, 0x73_u8])
    def query_interface(this : IAmsiStream*, riid : LibC::GUID*, ppvObject : Void**) : Win32cr::Foundation::HRESULT
      @lpVtbl.try &.value.query_interface.call(this, riid, ppvObject)
    end
    def add_ref(this : IAmsiStream*) : UInt32
      @lpVtbl.try &.value.add_ref.call(this)
    end
    def release(this : IAmsiStream*) : UInt32
      @lpVtbl.try &.value.release.call(this)
    end
    def get_attribute(this : IAmsiStream*, attribute : Win32cr::System::Antimalware::AMSI_ATTRIBUTE, dataSize : UInt32, data : UInt8*, retData : UInt32*) : Win32cr::Foundation::HRESULT
      @lpVtbl.try &.value.get_attribute.call(this, attribute, dataSize, data, retData)
    end
    def read(this : IAmsiStream*, position : UInt64, size : UInt32, buffer : UInt8*, readSize : UInt32*) : Win32cr::Foundation::HRESULT
      @lpVtbl.try &.value.read.call(this, position, size, buffer, readSize)
    end

  end

  @[Extern]
  record IAntimalwareProviderVtbl,
    query_interface : Proc(IAntimalwareProvider*, LibC::GUID*, Void**, Win32cr::Foundation::HRESULT),
    add_ref : Proc(IAntimalwareProvider*, UInt32),
    release : Proc(IAntimalwareProvider*, UInt32),
    scan : Proc(IAntimalwareProvider*, Void*, Win32cr::System::Antimalware::AMSI_RESULT*, Win32cr::Foundation::HRESULT),
    close_session : Proc(IAntimalwareProvider*, UInt64, Void),
    display_name : Proc(IAntimalwareProvider*, Win32cr::Foundation::PWSTR*, Win32cr::Foundation::HRESULT)


  @[Extern]
  #@[Com("b2cabfe3-fe04-42b1-a5df-08d483d4d125")]
  record IAntimalwareProvider, lpVtbl : IAntimalwareProviderVtbl* do
    GUID = LibC::GUID.new(0xb2cabfe3_u32, 0xfe04_u16, 0x42b1_u16, StaticArray[0xa5_u8, 0xdf_u8, 0x8_u8, 0xd4_u8, 0x83_u8, 0xd4_u8, 0xd1_u8, 0x25_u8])
    def query_interface(this : IAntimalwareProvider*, riid : LibC::GUID*, ppvObject : Void**) : Win32cr::Foundation::HRESULT
      @lpVtbl.try &.value.query_interface.call(this, riid, ppvObject)
    end
    def add_ref(this : IAntimalwareProvider*) : UInt32
      @lpVtbl.try &.value.add_ref.call(this)
    end
    def release(this : IAntimalwareProvider*) : UInt32
      @lpVtbl.try &.value.release.call(this)
    end
    def scan(this : IAntimalwareProvider*, stream : Void*, result : Win32cr::System::Antimalware::AMSI_RESULT*) : Win32cr::Foundation::HRESULT
      @lpVtbl.try &.value.scan.call(this, stream, result)
    end
    def close_session(this : IAntimalwareProvider*, session : UInt64) : Void
      @lpVtbl.try &.value.close_session.call(this, session)
    end
    def display_name(this : IAntimalwareProvider*, displayName : Win32cr::Foundation::PWSTR*) : Win32cr::Foundation::HRESULT
      @lpVtbl.try &.value.display_name.call(this, displayName)
    end

  end

  @[Extern]
  record IAntimalwareUacProviderVtbl,
    query_interface : Proc(IAntimalwareUacProvider*, LibC::GUID*, Void**, Win32cr::Foundation::HRESULT),
    add_ref : Proc(IAntimalwareUacProvider*, UInt32),
    release : Proc(IAntimalwareUacProvider*, UInt32),
    uac_scan : Proc(IAntimalwareUacProvider*, Win32cr::System::Antimalware::AMSI_UAC_REQUEST_CONTEXT*, Win32cr::System::Antimalware::AMSI_RESULT*, Win32cr::Foundation::HRESULT),
    display_name : Proc(IAntimalwareUacProvider*, Win32cr::Foundation::PWSTR*, Win32cr::Foundation::HRESULT)


  @[Extern]
  #@[Com("b2cabfe4-fe04-42b1-a5df-08d483d4d125")]
  record IAntimalwareUacProvider, lpVtbl : IAntimalwareUacProviderVtbl* do
    GUID = LibC::GUID.new(0xb2cabfe4_u32, 0xfe04_u16, 0x42b1_u16, StaticArray[0xa5_u8, 0xdf_u8, 0x8_u8, 0xd4_u8, 0x83_u8, 0xd4_u8, 0xd1_u8, 0x25_u8])
    def query_interface(this : IAntimalwareUacProvider*, riid : LibC::GUID*, ppvObject : Void**) : Win32cr::Foundation::HRESULT
      @lpVtbl.try &.value.query_interface.call(this, riid, ppvObject)
    end
    def add_ref(this : IAntimalwareUacProvider*) : UInt32
      @lpVtbl.try &.value.add_ref.call(this)
    end
    def release(this : IAntimalwareUacProvider*) : UInt32
      @lpVtbl.try &.value.release.call(this)
    end
    def uac_scan(this : IAntimalwareUacProvider*, context : Win32cr::System::Antimalware::AMSI_UAC_REQUEST_CONTEXT*, result : Win32cr::System::Antimalware::AMSI_RESULT*) : Win32cr::Foundation::HRESULT
      @lpVtbl.try &.value.uac_scan.call(this, context, result)
    end
    def display_name(this : IAntimalwareUacProvider*, displayName : Win32cr::Foundation::PWSTR*) : Win32cr::Foundation::HRESULT
      @lpVtbl.try &.value.display_name.call(this, displayName)
    end

  end

  @[Extern]
  record IAntimalwareProvider2Vtbl,
    query_interface : Proc(IAntimalwareProvider2*, LibC::GUID*, Void**, Win32cr::Foundation::HRESULT),
    add_ref : Proc(IAntimalwareProvider2*, UInt32),
    release : Proc(IAntimalwareProvider2*, UInt32),
    scan : Proc(IAntimalwareProvider2*, Void*, Win32cr::System::Antimalware::AMSI_RESULT*, Win32cr::Foundation::HRESULT),
    close_session : Proc(IAntimalwareProvider2*, UInt64, Void),
    display_name : Proc(IAntimalwareProvider2*, Win32cr::Foundation::PWSTR*, Win32cr::Foundation::HRESULT),
    notify : Proc(IAntimalwareProvider2*, Void*, UInt32, Win32cr::Foundation::PWSTR, Win32cr::Foundation::PWSTR, Win32cr::System::Antimalware::AMSI_RESULT*, Win32cr::Foundation::HRESULT)


  @[Extern]
  #@[Com("7c1e6570-3f73-4e0f-8ad4-98b94cd3290f")]
  record IAntimalwareProvider2, lpVtbl : IAntimalwareProvider2Vtbl* do
    GUID = LibC::GUID.new(0x7c1e6570_u32, 0x3f73_u16, 0x4e0f_u16, StaticArray[0x8a_u8, 0xd4_u8, 0x98_u8, 0xb9_u8, 0x4c_u8, 0xd3_u8, 0x29_u8, 0xf_u8])
    def query_interface(this : IAntimalwareProvider2*, riid : LibC::GUID*, ppvObject : Void**) : Win32cr::Foundation::HRESULT
      @lpVtbl.try &.value.query_interface.call(this, riid, ppvObject)
    end
    def add_ref(this : IAntimalwareProvider2*) : UInt32
      @lpVtbl.try &.value.add_ref.call(this)
    end
    def release(this : IAntimalwareProvider2*) : UInt32
      @lpVtbl.try &.value.release.call(this)
    end
    def scan(this : IAntimalwareProvider2*, stream : Void*, result : Win32cr::System::Antimalware::AMSI_RESULT*) : Win32cr::Foundation::HRESULT
      @lpVtbl.try &.value.scan.call(this, stream, result)
    end
    def close_session(this : IAntimalwareProvider2*, session : UInt64) : Void
      @lpVtbl.try &.value.close_session.call(this, session)
    end
    def display_name(this : IAntimalwareProvider2*, displayName : Win32cr::Foundation::PWSTR*) : Win32cr::Foundation::HRESULT
      @lpVtbl.try &.value.display_name.call(this, displayName)
    end
    def notify(this : IAntimalwareProvider2*, buffer : Void*, length : UInt32, contentName : Win32cr::Foundation::PWSTR, appName : Win32cr::Foundation::PWSTR, pResult : Win32cr::System::Antimalware::AMSI_RESULT*) : Win32cr::Foundation::HRESULT
      @lpVtbl.try &.value.notify.call(this, buffer, length, contentName, appName, pResult)
    end

  end

  @[Extern]
  record IAntimalwareVtbl,
    query_interface : Proc(IAntimalware*, LibC::GUID*, Void**, Win32cr::Foundation::HRESULT),
    add_ref : Proc(IAntimalware*, UInt32),
    release : Proc(IAntimalware*, UInt32),
    scan : Proc(IAntimalware*, Void*, Win32cr::System::Antimalware::AMSI_RESULT*, Void**, Win32cr::Foundation::HRESULT),
    close_session : Proc(IAntimalware*, UInt64, Void)


  @[Extern]
  #@[Com("82d29c2e-f062-44e6-b5c9-3d9a2f24a2df")]
  record IAntimalware, lpVtbl : IAntimalwareVtbl* do
    GUID = LibC::GUID.new(0x82d29c2e_u32, 0xf062_u16, 0x44e6_u16, StaticArray[0xb5_u8, 0xc9_u8, 0x3d_u8, 0x9a_u8, 0x2f_u8, 0x24_u8, 0xa2_u8, 0xdf_u8])
    def query_interface(this : IAntimalware*, riid : LibC::GUID*, ppvObject : Void**) : Win32cr::Foundation::HRESULT
      @lpVtbl.try &.value.query_interface.call(this, riid, ppvObject)
    end
    def add_ref(this : IAntimalware*) : UInt32
      @lpVtbl.try &.value.add_ref.call(this)
    end
    def release(this : IAntimalware*) : UInt32
      @lpVtbl.try &.value.release.call(this)
    end
    def scan(this : IAntimalware*, stream : Void*, result : Win32cr::System::Antimalware::AMSI_RESULT*, provider : Void**) : Win32cr::Foundation::HRESULT
      @lpVtbl.try &.value.scan.call(this, stream, result, provider)
    end
    def close_session(this : IAntimalware*, session : UInt64) : Void
      @lpVtbl.try &.value.close_session.call(this, session)
    end

  end

  @[Extern]
  record IAntimalware2Vtbl,
    query_interface : Proc(IAntimalware2*, LibC::GUID*, Void**, Win32cr::Foundation::HRESULT),
    add_ref : Proc(IAntimalware2*, UInt32),
    release : Proc(IAntimalware2*, UInt32),
    scan : Proc(IAntimalware2*, Void*, Win32cr::System::Antimalware::AMSI_RESULT*, Void**, Win32cr::Foundation::HRESULT),
    close_session : Proc(IAntimalware2*, UInt64, Void),
    notify : Proc(IAntimalware2*, Void*, UInt32, Win32cr::Foundation::PWSTR, Win32cr::Foundation::PWSTR, Win32cr::System::Antimalware::AMSI_RESULT*, Win32cr::Foundation::HRESULT)


  @[Extern]
  #@[Com("301035b5-2d42-4f56-8c65-2dcaa7fb3cdc")]
  record IAntimalware2, lpVtbl : IAntimalware2Vtbl* do
    GUID = LibC::GUID.new(0x301035b5_u32, 0x2d42_u16, 0x4f56_u16, StaticArray[0x8c_u8, 0x65_u8, 0x2d_u8, 0xca_u8, 0xa7_u8, 0xfb_u8, 0x3c_u8, 0xdc_u8])
    def query_interface(this : IAntimalware2*, riid : LibC::GUID*, ppvObject : Void**) : Win32cr::Foundation::HRESULT
      @lpVtbl.try &.value.query_interface.call(this, riid, ppvObject)
    end
    def add_ref(this : IAntimalware2*) : UInt32
      @lpVtbl.try &.value.add_ref.call(this)
    end
    def release(this : IAntimalware2*) : UInt32
      @lpVtbl.try &.value.release.call(this)
    end
    def scan(this : IAntimalware2*, stream : Void*, result : Win32cr::System::Antimalware::AMSI_RESULT*, provider : Void**) : Win32cr::Foundation::HRESULT
      @lpVtbl.try &.value.scan.call(this, stream, result, provider)
    end
    def close_session(this : IAntimalware2*, session : UInt64) : Void
      @lpVtbl.try &.value.close_session.call(this, session)
    end
    def notify(this : IAntimalware2*, buffer : Void*, length : UInt32, contentName : Win32cr::Foundation::PWSTR, appName : Win32cr::Foundation::PWSTR, pResult : Win32cr::System::Antimalware::AMSI_RESULT*) : Win32cr::Foundation::HRESULT
      @lpVtbl.try &.value.notify.call(this, buffer, length, contentName, appName, pResult)
    end

  end

  @[Link("amsi")]
  @[Link("kernel32")]
  lib C
    fun AmsiInitialize(appName : Win32cr::Foundation::PWSTR, amsiContext : Win32cr::System::Antimalware::HAMSICONTEXT*) : Win32cr::Foundation::HRESULT

    fun AmsiUninitialize(amsiContext : Win32cr::System::Antimalware::HAMSICONTEXT) : Void

    fun AmsiOpenSession(amsiContext : Win32cr::System::Antimalware::HAMSICONTEXT, amsiSession : Win32cr::System::Antimalware::HAMSISESSION*) : Win32cr::Foundation::HRESULT

    fun AmsiCloseSession(amsiContext : Win32cr::System::Antimalware::HAMSICONTEXT, amsiSession : Win32cr::System::Antimalware::HAMSISESSION) : Void

    fun AmsiScanBuffer(amsiContext : Win32cr::System::Antimalware::HAMSICONTEXT, buffer : Void*, length : UInt32, contentName : Win32cr::Foundation::PWSTR, amsiSession : Win32cr::System::Antimalware::HAMSISESSION, result : Win32cr::System::Antimalware::AMSI_RESULT*) : Win32cr::Foundation::HRESULT

    fun AmsiNotifyOperation(amsiContext : Win32cr::System::Antimalware::HAMSICONTEXT, buffer : Void*, length : UInt32, contentName : Win32cr::Foundation::PWSTR, result : Win32cr::System::Antimalware::AMSI_RESULT*) : Win32cr::Foundation::HRESULT

    fun AmsiScanString(amsiContext : Win32cr::System::Antimalware::HAMSICONTEXT, string : Win32cr::Foundation::PWSTR, contentName : Win32cr::Foundation::PWSTR, amsiSession : Win32cr::System::Antimalware::HAMSISESSION, result : Win32cr::System::Antimalware::AMSI_RESULT*) : Win32cr::Foundation::HRESULT

    fun InstallELAMCertificateInfo(elam_file : Win32cr::Foundation::HANDLE) : Win32cr::Foundation::BOOL

  end
end